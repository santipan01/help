--========================================================--
-- SantiPan Helper + Tool ESP
--========================================================--

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CAS = game:GetService("ContextActionService")
local uis = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local backpack = player:WaitForChild("Backpack")
local char = player.Character or player.CharacterAdded:Wait()

--========================================================--
-- Variables principales
--========================================================--

local TOOL_NAME_CLOAK = "Invisibility Cloak"
local CLICK_DELAY = 0.12
local EQUIP_DELAY = 0.02
local v5Enabled = false
local toolESPEnabled = false

local TOOL_NAME_MEGA = "Megaphone"
local COOLDOWN_TIME = 20
local TELEPORT_POSITION = Vector3.new(0, 20, 0)
local FIRE_KEY = Enum.KeyCode.P
local TELEPORT_KEY = Enum.KeyCode.T

--========================================================--
-- Funciones Cloak
--========================================================--

local function getCloakTool()
	return backpack:FindFirstChild(TOOL_NAME_CLOAK) or (char and char:FindFirstChild(TOOL_NAME_CLOAK))
end

local function forceEquipCloak()
	if not char then return end
	local t = backpack:FindFirstChild(TOOL_NAME_CLOAK)
	if t then t.Parent = char end
	local t2 = char:FindFirstChild(TOOL_NAME_CLOAK)
	if t2 and t2.Parent ~= char then t2.Parent = char end
end

local function triggerActionCloak(tool)
	if not tool then return end
	pcall(function() tool:Activate() end)
	for _, v in ipairs(tool:GetDescendants()) do
		if v:IsA("RemoteEvent") then
			pcall(function() v:FireServer() end)
		end
	end
	pcall(function()
		CAS:BindAction("SpamClick", function() end, false, Enum.UserInputType.MouseButton1)
		CAS:UnbindAction("SpamClick")
	end)
end

task.spawn(function()
	while true do
		task.wait(CLICK_DELAY)
		if v5Enabled then triggerActionCloak(getCloakTool()) end
	end
end)

RunService.RenderStepped:Connect(function()
	if v5Enabled then forceEquipCloak() end
end)

task.spawn(function()
	while true do
		if v5Enabled then forceEquipCloak() end
		task.wait(EQUIP_DELAY)
	end
end)

player.CharacterAdded:Connect(function(nc)
	char = nc
	backpack = player:WaitForChild("Backpack")
end)

--========================================================--
-- Funciones Tool ESP
--========================================================--

local function createToolGui(p)
	local char = p.Character
	if not char then return end
	local head = char:FindFirstChild("Head")
	if not head then return end

	if head:FindFirstChild("ToolsImagesGui") then
		return head.ToolsImagesGui
	end

	local gui = Instance.new("BillboardGui")
	gui.Name = "ToolsImagesGui"
	gui.Size = UDim2.new(0, 270, 0, 50)
	gui.StudsOffset = Vector3.new(0, 4.5, 0)
	gui.AlwaysOnTop = true
	gui.Enabled = false
	gui.Parent = head

	local holder = Instance.new("Frame")
	holder.Name = "Holder"
	holder.Size = UDim2.new(1,0,1,0)
	holder.BackgroundTransparency = 1
	holder.Parent = gui

	return gui
end

local function getToolTexture(tool)
	if tool:FindFirstChild("TextureId") then
		return tool.TextureId
	end
	if tool:IsA("Tool") and tool.TextureId then
		return tool.TextureId
	end
	return "rbxassetid://0"
end

local function updatePlayerTools(p)
	local char = p.Character
	if not char then return end
	local head = char:FindFirstChild("Head")
	if not head then return end
	local gui = head:FindFirstChild("ToolsImagesGui") or createToolGui(p)
	if not gui then return end

	gui.Enabled = toolESPEnabled

	local holder = gui:FindFirstChild("Holder")
	if not holder then return end

	for _, obj in ipairs(holder:GetChildren()) do
		if obj:IsA("ImageLabel") then
			obj:Destroy()
		end
	end

	local tools = {}
	local backpack = p:FindFirstChild("Backpack")
	if backpack then
		for _, item in ipairs(backpack:GetChildren()) do
			if item:IsA("Tool") then
				table.insert(tools, item)
			end
		end
	end

	for _, item in ipairs(char:GetChildren()) do
		if item:IsA("Tool") then
			table.insert(tools, item)
		end
	end

	for i = 1, math.min(6, #tools) do
		local tool = tools[i]
		local img = Instance.new("ImageLabel")
		img.Size = UDim2.new(0,40,0,40)
		img.Position = UDim2.new(0, (i-1)*45, 0, 0)
		img.BackgroundTransparency = 1
		img.Image = tool and getToolTexture(tool) or "rbxassetid://0"
		img.Parent = holder
	end
end

--========================================================--
-- GUI Principal
--========================================================--

local gui = Instance.new("ScreenGui")
gui.Name = "CombinedController"
gui.ResetOnSpawn = false
gui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 175, 0, 260)
frame.Position = UDim2.new(0.8, 0, 0.45, -130)
frame.BackgroundColor3 = Color3.fromRGB(240, 240, 250)
frame.BackgroundTransparency = 0.1
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = gui
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 14)

local topbar = Instance.new("Frame", frame)
topbar.Size = UDim2.new(1,0,0,32)
topbar.BackgroundColor3 = Color3.fromRGB(255,255,255)
topbar.BackgroundTransparency = 0.3
topbar.BorderSizePixel = 0
Instance.new("UICorner", topbar).CornerRadius = UDim.new(0,14)

local title = Instance.new("TextLabel", topbar)
title.Size = UDim2.new(1,0,1,0)
title.BackgroundTransparency = 1
title.Text = "SantiPan Helper â˜„ï¸"
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(255,255,255)
title.TextSize = 14
title.TextStrokeTransparency = 0
title.TextStrokeColor3 = Color3.fromRGB(0,0,0)

local t = 0
RunService.RenderStepped:Connect(function(dt)
	t = t + dt
	local c = Color3.fromRGB(
		math.floor(255 - 95*math.sin(t*2)),
		math.floor(255 - 95*math.sin(t*2)),
		math.floor(255 - 95*math.sin(t*2))
	)
	title.TextColor3 = c
end)

local function makeButton(text, y)
	local b = Instance.new("TextButton")
	b.Size = UDim2.new(1, -24, 0, 36)
	b.Position = UDim2.new(0, 12, 0, y)
	b.BackgroundColor3 = Color3.fromRGB(255,255,255)
	b.BackgroundTransparency = 0.15
	b.Font = Enum.Font.GothamBold
	b.TextSize = 13
	b.Text = text
	b.TextColor3 = Color3.fromRGB(40,40,40)
	b.Parent = frame
	Instance.new("UICorner", b).CornerRadius = UDim.new(0, 10)
	return b
end

--========================================================--
-- Botones
--========================================================--

local fireBtn = makeButton("Disparo", 45)
local desyncBtn = makeButton("ðŸŒ€ Desync", 85)
local respawnBtn = makeButton("Respawn", 125)
local v5Btn = makeButton("FPS Devourer V5", 165)
local toolESPBtn = makeButton("Tool ESP: OFF", 205)

--========================================================--
-- Tool ESP toggle arreglado
--========================================================--

toolESPBtn.MouseButton1Click:Connect(function()
	toolESPEnabled = not toolESPEnabled
	toolESPBtn.Text = toolESPEnabled and "Tool ESP: ON" or "Tool ESP: OFF"
	toolESPBtn.BackgroundColor3 = toolESPEnabled and Color3.fromRGB(180,255,180) or Color3.fromRGB(255,255,255)

	-- Actualizar todos los jugadores actuales
	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= player then
			local char = p.Character
			if char and char:FindFirstChild("Head") then
				local gui = char.Head:FindFirstChild("ToolsImagesGui") or createToolGui(p)
				if gui then
					gui.Enabled = toolESPEnabled
				end
			end
		end
	end
end)

--========================================================--
-- Funciones Megaphone, V5, Respawn, Desync
--========================================================--

local lastUseTime = -COOLDOWN_TIME

local function canUse()
	return tick() - lastUseTime >= COOLDOWN_TIME
end

local function updateCooldown()
	local now = tick()
	local remain = math.max(0, COOLDOWN_TIME - (now - lastUseTime))
	fireBtn.Text = remain > 0 and ("Disparo ("..math.ceil(remain).."s)") or "Disparo"
end

local function useMegaphone()
	if not canUse() then return end
	lastUseTime = tick()
	updateCooldown()
	local c = player.Character or player.CharacterAdded:Wait()
	local bp = player:FindFirstChild("Backpack")
	if not bp then return end
	local tool = bp:FindFirstChild(TOOL_NAME_MEGA) or c:FindFirstChild(TOOL_NAME_MEGA)
	if tool then
		tool.Parent = c
		pcall(function() tool:Activate() end)
		local remote = tool:FindFirstChildWhichIsA("RemoteEvent", true)
		if remote then remote:FireServer() end
	end
end

fireBtn.MouseButton1Click:Connect(useMegaphone)
uis.InputBegan:Connect(function(i,gp)
	if not gp and i.KeyCode == FIRE_KEY then useMegaphone() end
end)

local function notify(text, duration)
	duration = duration or 2
	local n = Instance.new("Frame")
	n.Size = UDim2.new(0,200,0,40)
	n.Position = UDim2.new(0.5,-100,-0.1,0)
	n.BackgroundColor3 = Color3.fromRGB(240,240,250)
	n.BackgroundTransparency = 0.1
	n.BorderSizePixel = 0
	n.Parent = gui
	Instance.new("UICorner", n).CornerRadius = UDim.new(0,10)
	local label = Instance.new("TextLabel", n)
	label.Size = UDim2.new(1,0,1,0)
	label.BackgroundTransparency = 1
	label.Font = Enum.Font.GothamBold
	label.TextSize = 14
	label.TextColor3 = Color3.fromRGB(40,40,40)
	label.Text = text
	TweenService:Create(n, TweenInfo.new(0.3), {Position = UDim2.new(0.5,-100,0.05,0)}):Play()
	task.delay(duration, function()
		TweenService:Create(n, TweenInfo.new(0.4), {Position = UDim2.new(0.5,-100,-0.1,0), BackgroundTransparency = 1}):Play()
		task.delay(0.4, function() n:Destroy() end)
	end)
end

local function teleport()
	local c = player.Character
	if c and c:FindFirstChild("HumanoidRootPart") then
		c.HumanoidRootPart.CFrame = CFrame.new(TELEPORT_POSITION)
	end
end

local function triggerDesync()
	notify("Actualizando Desync...", 0.2)
	task.delay(0.3, function()
		notify("Actualizado", 1)
	end)
	teleport()
end

desyncBtn.MouseButton1Click:Connect(triggerDesync)
uis.InputBegan:Connect(function(input, gp)
	if not gp and input.KeyCode == TELEPORT_KEY then triggerDesync() end
end)

local function forceRespawn()
	notify("Respawning...", 1)
	for i = 1,10 do
		if player.Character then
			local hum = player.Character:FindFirstChild("Humanoid")
			if hum then hum.Health = 0 end
			player.Character:Destroy()
		end
		task.wait(0.01)
		player:LoadCharacter()
		task.wait(0.01)
		if player.Character and player.Character:FindFirstChild("Humanoid") then break end
	end
end

respawnBtn.MouseButton1Click:Connect(forceRespawn)

task.spawn(function()
	while true do
		updateCooldown()
		task.wait(0.05)
	end
end)

v5Btn.MouseButton1Click:Connect(function()
	v5Enabled = not v5Enabled
	if v5Enabled then
		v5Btn.Text = "FPS Devourer V5 (ON)"
		v5Btn.BackgroundColor3 = Color3.fromRGB(200,255,200)
		notify("Fps Devourer v5 ðŸ§· (Beta)", 1.5)
		task.delay(1.6, function()
			notify("No funciona con Brainrot ðŸš«", 2.5)
		end)
	else
		v5Btn.Text = "FPS Devourer V5"
		v5Btn.BackgroundColor3 = Color3.fromRGB(255,255,255)
		notify("SantiPan ðŸ”¥", 1)
	end
end)

--========================================================--
-- Loop Tool ESP (actualiza automÃ¡ticamente)
--========================================================--

RunService.Heartbeat:Connect(function()
	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= player then
			updatePlayerTools(p)
		end
	end
end)

Players.PlayerAdded:Connect(function(p)
	p.CharacterAdded:Connect(function()
		task.wait(1)
		createToolGui(p)
	end)
end)
